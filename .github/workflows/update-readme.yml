name: Update README stats

on:
  schedule:
    # ë§¤ì¼ KST ì˜¤ì „ 6ì‹œì— ì‹¤í–‰ (UTC 21:00 ì „ë‚ )
    - cron: "0 21 * * *"
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼
  push:
    branches: [ main ]  # main ë¸Œëœì¹˜ë§Œ

permissions:
  contents: write  # README ê°±ì‹  ì»¤ë°‹ ê¶Œí•œ

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate total problem stats
        shell: bash
        run: |
          set -euo pipefail

          # ë””ë ‰í† ë¦¬ ë‚´ Java/Kotlin í’€ì´ íŒŒì¼ ê°œìˆ˜ í•©ì‚°
          # (#######í•„ìš”ì‹œí™•ì¥: ë‹¤ë¥¸ ì–¸ì–´ ì¶”ê°€ ì‹œ -o -name "*.py" ë“±ìœ¼ë¡œ í™•ì¥)
          count_platform () {
            local platform="$1"
            if [ -d "$platform" ]; then
              find "$platform" -type f \( -name "*.java" -o -name "*.kt" \) | wc -l
            else
              echo 0
            fi
          }

          # í”Œë«í¼ë³„ ê°œìˆ˜ (í˜„ì¬: Baekjoon, Programmers ë‘ ê°€ì§€ë§Œ ì§‘ê³„)
          baekjoon=$(count_platform "Baekjoon")
          programmers=$(count_platform "Programmers")
          total=$((baekjoon + programmers))

          # íƒ€ì„ì¡´ KSTë¡œ í‘œì‹œ
          export TZ=Asia/Seoul
          now="$(date '+%Y-%m-%d %H:%M %Z')"

          # READMEì— ì‚½ì…í•  ì½˜í…ì¸ 
          CONTENT=$(
cat <<EOF
############ README ì‚½ì… ì½˜í…ì¸  (ì‹œì‘) ############

### ğŸš€ ë¬¸ì œ í’€ì´ í˜„í™© (ìë™)
- Baekjoon: ${baekjoon} ë¬¸ì œ
- Programmers: ${programmers} ë¬¸ì œ

- Total: ${total} ë¬¸ì œ

Updated: ${now}

############ README ì‚½ì… ì½˜í…ì¸  (ë) ############
EOF
          )

          # ë§ˆì»¤ ì´ë¦„: TOTAL_PROBLEM_STATS_START / TOTAL_PROBLEM_STATS_END
          # ë§ˆì»¤ê°€ ì´ë¯¸ ìˆìœ¼ë©´ ì‚¬ì´ êµ¬ê°„ ì „ì²´ ì¹˜í™˜, ì—†ìœ¼ë©´ ë§¨ ì•„ë˜ì— ì¶”ê°€
          if grep -q "<!-- TOTAL_PROBLEM_STATS_START -->" README.md && grep -q "<!-- TOTAL_PROBLEM_STATS_END -->" README.md; then
            sed -i -e "/<!-- TOTAL_PROBLEM_STATS_START -->/,/<!-- TOTAL_PROBLEM_STATS_END -->/c\\<!-- TOTAL_PROBLEM_STATS_START -->\\
${CONTENT}\\
<!-- TOTAL_PROBLEM_STATS_END -->" README.md
          else
            {
              echo ""
              echo "<!-- TOTAL_PROBLEM_STATS_START -->"
              echo "${CONTENT}"
              echo "<!-- TOTAL_PROBLEM_STATS_END -->"
            } >> README.md
          fi

          # ë³€ê²½ì‚¬í•­ ìˆì„ ë•Œë§Œ ì»¤ë°‹/í‘¸ì‹œ
          if ! git diff --quiet; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add README.md
            git commit -m "chore(readme): auto-update problem stats"
            git push
          else
            echo "No changes."
          fi
