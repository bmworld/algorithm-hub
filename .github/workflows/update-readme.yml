name: Update README stats

on:
  #  schedule:
  # ë§¤ì¼ KST ì˜¤ì „ 6ì‹œì— ì‹¤í–‰ (UTC 21:00 ì „ë‚ )
  #    - cron: "0 21 * * *"
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼
  push:
    branches: [ main ]  # main ë¸Œëœì¹˜ë§Œ

permissions:
  contents: write  # README ê°±ì‹  ì»¤ë°‹ ê¶Œí•œ

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate total problem stats
        shell: bash
        run: |
          set -euo pipefail
          
          # ê²½ë¡œ: root/work/Java/ë°±ì¤€, root/work/Kotlin/ë°±ì¤€
          count_dir () {
            local dir="$1" ext="$2"
            if [ -d "$dir" ]; then
              find "$dir" -type f -name "$ext" 2>/dev/null | wc -l
            else
              echo 0
            fi
          }

          # ì˜¨ë¼ì¸ ì €ì§€: ë°±ì¤€
          baekjoon_java=$(count_dir "work/Java/ë°±ì¤€" "*.java")
          baekjoon_kotlin=$(count_dir "work/Kotlin/ë°±ì¤€" "*.kt")
          baekjoon_total=$((baekjoon_java + baekjoon_kotlin))

          # í•„ìš” ì‹œ ë‹¤ë¥¸ ì €ì§€(í”„ë¡œê·¸ë˜ë¨¸ìŠ¤ ë“±) ì¶”ê°€ ì˜ˆì •ì´ë©´ ì—¬ê¸°ì„œ ëˆ„ì 
          total=$((baekjoon_total))
          
          # íƒ€ì„ì¡´ KSTë¡œ í‘œì‹œ
          export TZ=Asia/Seoul
          now="$(date '+%Y-%m-%d %H:%M %Z')"
          
          # READMEì— ì‚½ì…í•  ì½˜í…ì¸  â†’ ì„ì‹œ íŒŒì¼ë¡œ ìƒì„±
          CONTENT_FILE="$(mktemp)"
          printf "%s\n" \
          "## ğŸš€ ë¬¸ì œ ì§‘ê³„ (${now})" \
          "- Baekjoon: ${baekjoon_total} ë¬¸ì œ" \
          "- Programmers: ${programmers} ë¬¸ì œ" \
          "- Total: ${total} ë¬¸ì œ" \
          > "$CONTENT_FILE"
          
          START="<!-- TOTAL_PROBLEM_STATS_START -->"
          END="<!-- TOTAL_PROBLEM_STATS_END -->"
          
          if grep -q "$START" README.md && grep -q "$END" README.md; then
            # ë§ˆì»¤ ì‚¬ì´ë¥¼ ì„ì‹œíŒŒì¼ ë‚´ìš©ìœ¼ë¡œ êµì²´ (GNU sed)
            sed -i -e "/$START/,/$END/{
            /$START/{
            p
            r $CONTENT_FILE
            }
              /$END/p
              d
            }" README.md
          else
          {
            echo ""
            echo "$START"
            cat "$CONTENT_FILE"
            echo "$END"
          } >> README.md
          fi
          
          rm -f "$CONTENT_FILE"
          
          # ë³€ê²½ì‚¬í•­ ìˆì„ ë•Œë§Œ ì»¤ë°‹/í‘¸ì‹œ
          if ! git diff --quiet; then
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "chore(readme): auto-update problem stats"
          git push
          else
          echo "No changes."
          fi
